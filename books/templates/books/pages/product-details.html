{% load static %}
{% load custom_filters %}
{% block link %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
{% endblock %}


{% block style %}
    <style>
        .project-overview{
            border: 2px solid #198754 !important;
        }

        .nav-tabs .nav-link {
            color: #333;
            border: none;
            padding: 10px 20px;
        }

        .nav-tabs .nav-link.active {
            color: #198754;
            border-bottom: 2px solid #198754;
            background: none;
        }

        .tab-content>.tab-pane {
            display: none;
        }

        .tab-content>.tab-pane.active {
            display: block;
        }

        .related-work {
            padding: 15px;
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .related-work a {
            text-decoration: none;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            display: block;
            padding: 8px 12px;
            transition: color 0.3s ease;
        }

        .related-works li {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .add-review-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .document-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .ayatutu-definition {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .generated-words {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }


        .no-select {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: default;
        }

        .document-details span{
            text-transform:initial;
            text-transform: lowercase;
            font-style: italic;
        }

        /* Prevent screenshot/saving */
        #documentModal {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .modal-body {
            max-height: 500px;
            overflow-y: auto;
        }
        /* Watermark effect */
        .watermarked {
            position: relative;
        }
        .watermarked::before {
            content: "CONFIDENTIAL";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 40px;
            color: rgba(255,0,0,0.1);
            pointer-events: none;
            z-index: 1;
        }

    
    #pdf-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }
    .pdf-page {
        max-width: 100%;
        height: auto;
        margin-bottom: 10px;
    }
    .lead{
        text-align:justify;
    }

    </style>
    {% endblock %}

    <div class="container mt-4" style="margin-top: 6.5rem !important;">
        <h1 class="h2 mb-4">{{book.title}}</h1>

        <div class="row">
            <div class="col-md-8 project-overview">
                <ul class="nav nav-tabs mb-4" id="paperTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="citations-tab" data-bs-toggle="tab" data-bs-target="#citations" type="button" role="tab">Cite Work</button>
                    </li>
                </ul>

                <div class="tab-content" id="paperTabsContent">
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="content mb-4">
                            <p class="lead">{{ book.description|unescape_html|truncatehtml:500|safe }}</p>
                            <div class="container col-md-6 mt-5 align-items-center">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#documentModal">
                                    Preview Document
                                </button>
                            </div>
                        </div>

                        <div class="modal fade" id="documentModal" tabindex="-1">
                            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                <div class="modal-content no-select watermarked">
                                    <div class="modal-header">
                                        <h5 class="modal-title">{{book.title}}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="document-content" id="pdf-container">
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p>Loading document preview...</p>
                                            </div>
                                        </div>
                                        <img src="{% static 'books/images/hero_image_1.jpg' %}" alt="advert" style="width: 20%;">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        {% if request.user.is_authenticated %}
                                            <a class="btn btn-success" id="downloadBtn" href="{% url 'subscriptions:buyorsubscribe' book.id %}">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        {% else %}
                                            <a class="btn btn-success" id="downloadBtn" href="{% url 'subscriptions:buyorsubscribe' book.id %}">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="ayatutu-definition"></div>
                        <div class="ayatutu-definition"></div>
                    </div>

                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="review-card mb-3">
                            <div class="review-header">
                                <div>
                                    <h5>Excellent Analysis of Leadership Challenges</h5>
                                    <div class="text-muted">by John Doe</div>
                                </div>
                                <div class="review-score text-success">5.0</div>
                            </div>
                            <div class="review-content">
                                This paper provides a comprehensive and insightful analysis of the leadership
                                recruitment challenges in Nigeria. The author's use of the Ayatutu Ontology framework
                                offers a unique perspective on the deterioration of democratic consolidation. I found
                                the proposed reforms to the leadership system to be well-reasoned and practical. A
                                must-read for anyone interested in Nigerian politics and governance.
                            </div>
                        </div>

                        <div class="review-card mb-3">
                            <div class="review-header">
                                <div>
                                    <h5>Thought-Provoking and Relevant</h5>
                                    <div class="text-muted">by Jane Smith</div>
                                </div>
                                <div class="review-score text-success">4.8</div>
                            </div>
                            <div class="review-content">
                                The Ayatutu Ontology paper tackles a critical issue that has plagued Nigeria for far too
                                long - the failure of leadership and its impact on the country's democratic progress.
                                The author's deep dive into the leadership recruitment process and the proposed
                                solutions are both timely and necessary. This work should be required reading for
                                policymakers, academics, and anyone concerned about the future of Nigeria.
                            </div>
                        </div>

                        <div class="review-header">
                            <button class="btn btn-success" data-bs-toggle="collapse" data-bs-target="#addReviewForm">Add Review</button>
                        </div>
                        
                        <div class="collapse" id="addReviewForm">
                            <div class="add-review-section">
                                <form>
                                    <div class="mb-3">
                                        <label for="reviewTitle" class="form-label">Review Title</label>
                                        <input type="text" class="form-control" id="reviewTitle" placeholder="Enter a title for your review">
                                    </div>
                                    <div class="mb-3">
                                        <label for="reviewScore" class="form-label">Overall Score</label>
                                        <select class="form-select" id="reviewScore">
                                            <option value="5">5 - Excellent</option>
                                            <option value="4">4 - Very Good</option>
                                            <option value="3">3 - Good</option>
                                            <option value="2">2 - Fair</option>
                                            <option value="1">1 - Poor</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reviewContent" class="form-label">Your Review</label>
                                        <textarea class="form-control" id="reviewContent" rows="5" placeholder="Write your detailed review here"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Submit Review</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="citations" role="tabpanel">
                        <div class="citation-card">
                            <h4 class="mb-3">Citation Information</h4>
                            <div class="citation-content">
                                <h5>Full Citation:</h5>
                                <p>Akume, G. (2021). Ayatutu Ontology: The George Akume Leadership Recruitment Model.
                                    African and General Studies, 40, 14858.</p>

                                <h5 class="mt-3">Citation Formats:</h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>APA</h6>
                                        <pre class="bg-light p-2">Akume, G. (2021). Ayatutu Ontology: The George Akume Leadership Recruitment Model. African and General Studies, 40, 14858.</pre>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>MLA</h6>
                                        <pre class="bg-light p-2">Akume, George. "Ayatutu Ontology: The George Akume Leadership Recruitment Model." African and General Studies, vol. 40, 2021, pp. 14858.</pre>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Chicago</h6>
                                        <pre class="bg-light p-2">Akume, George. "Ayatutu Ontology: The George Akume Leadership Recruitment Model." African and General Studies 40 (2021): 14858.</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="document-details mb-4">
                    <h4 class="mb-3">Document Details</h4>
                    <div class="mb-3">
                        <div class="field-label">BY:</div>
                        <span class="text-success">{{book.author}}</span>
                    </div>
                    <div class="mb-3">
                        <div class="field-label">FIELD:</div>
                        <span>{{book.category.name}}</span>
                    </div>
                    <div class="mb-3">
                        <div class="field-label">TYPE:</div>
                        <span>{{book.book_type.name}}</span>
                    </div>
                    <div class="mb-3">
                        <div class="field-label">PAGES:</div>
                        <span id="page-count" class="stats-loading">Loading...</span>
                    </div>
                    <div class="mb-3">
                        <div class="field-label">CHAPTERS:</div>
                        <span>1 to 5 CHAPTERS</span>
                    </div>
                    
                    {% if request.user.is_authenticated %}
                        <a class="btn btn-success" id="downloadBtn" href="{% url 'subscriptions:buyorsubscribe' book.id %}">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% else %}
                        <a class="btn btn-success" id="downloadBtn" href="{% url 'subscriptions:buyorsubscribe' book.id %}">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% endif %}
                </div>
                
                <div class="related-works">
                    <h4 class="mb-3">Related Works</h4>
                    {% for related_book in related_books %}
                        <li class="related-work">
                            <a href="{% url 'books:product-details' related_book.id %}">
                                {{ related_book.title }}
                            </a>
                        </li>
                    {% empty %}
                        <li class="related-work">No related books found.</li>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Security measures
        document.body.addEventListener('selectstart', function(e) {
            e.preventDefault();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'PrintScreen' ||
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.key === 'p')) {
                e.preventDefault();
            }
        });

        // Load document stats via API
        function loadDocumentStats() {
            const bookId = JSON.parse('{{ book.id|safe|escapejs }}');
            fetch(`/api/books/${bookId}/preview/`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.page_count && data.word_count) {
                        document.getElementById('page-count').textContent = 
                            `${data.page_count} PAGES (${data.word_count} WORDS)`;
                        document.getElementById('page-count').classList.remove('stats-loading');
                    }
                })
                .catch(error => {
                    console.error('Error loading document stats:', error);
                    document.getElementById('page-count').textContent = 'Stats unavailable';
                    document.getElementById('page-count').classList.remove('stats-loading');
                });
        }

        // Initialize PDF viewer when modal opens
        function initPDFViewer() {
            const modal = document.getElementById('documentModal');
            if (!modal) return;

            modal.addEventListener('shown.bs.modal', function() {
                const container = document.getElementById('pdf-container');
                
                // Show loading state
                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading document preview...</p>
                    </div>
                `;
                
                // Fetch preview data from API
                fetch(`/api/books/{{ book.id }}/preview/`)
                    .then(response => {
                        if (!response.ok) throw new Error('Preview not available');
                        return response.json();
                    })
                    .then(data => {
                        if (!data.preview_url) throw new Error('No preview URL returned');
                        
                        // Initialize PDF.js
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 
                            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
                        
                        // Add cache buster
                        const url = data.preview_url + (data.preview_url.includes('?') ? '&' : '?') + 'v=' + Date.now();
                        
                        return pdfjsLib.getDocument({
                            url: url,
                            cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/cmaps/',
                            cMapPacked: true
                        }).promise;
                    })
                    .then(pdf => {
                        container.innerHTML = '';
                        
                        // Calculate optimal scale
                        const isMobile = window.innerWidth < 768;
                        const baseScale = isMobile ? 0.8 : 1.2;
                        const maxWidth = isMobile ? window.innerWidth * 0.9 : 800;
                        
                        // Function to render individual page
                        const renderPage = function(pageNum) {
                            pdf.getPage(pageNum).then(function(page) {
                                const viewport = page.getViewport({ scale: baseScale });
                                const scale = Math.min(baseScale, maxWidth / viewport.width);
                                const scaledViewport = page.getViewport({ scale: scale });
                                
                                const canvas = document.createElement('canvas');
                                canvas.className = 'pdf-page mb-3 shadow border';
                                container.appendChild(canvas);
                                
                                const context = canvas.getContext('2d');
                                canvas.height = scaledViewport.height;
                                canvas.width = scaledViewport.width;
                                
                                page.render({
                                    canvasContext: context,
                                    viewport: scaledViewport
                                });
                            }).catch(function(error) {
                                console.error(`Error rendering page: ${error}`);
                            });
                        };
                        
                        // Render first 3 pages immediately
                        for (let i = 1; i <= Math.min(3, pdf.numPages); i++) {
                            renderPage(i);
                        }
                        
                        // Render remaining pages with delay
                        for (let i = 4; i <= Math.min(10, pdf.numPages); i++) {
                            setTimeout(() => renderPage(i), 500 * (i-3));
                        }
                    })
                    .catch(error => {
                        console.error('Error loading PDF preview:', error);
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                Failed to load preview. Please try again later.
                                ${error.message ? `<small>Error: ${error.message}</small>` : ''}
                            </div>
                        `;
                    });
            });
        }

        // Initialize everything
        loadDocumentStats();
        initPDFViewer();
    });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>